<!DOCTYPE html5>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Voice and text</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="styles.css">
    <script src='https://code.responsivevoice.org/responsivevoice.js'></script>
    
</head>

<body>
    <div class="container" background-image="download.jpeg">

        <h1>Farmer Assistant</h1>
        <!-- <p class="page-description">A tiny app that allows you to ask queries</p> -->


        <h3 class="no-browser-support">Sorry, Your Browser Doesn't Support the Web Speech API. Try Opening This Demo In Google Chrome.</h3>
        <div class="ui large buttons">
            <button class="ui button active" id="speak_btn" onclick="show_speak_div()">ASK Question/‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡•ã &nbsp;
                <i class="fa fa-2x fa-volume-up"></i>
            </button>
            <div class="or"></div>
            <button class="ui button" id="type_btn" onclick="show_type_div()">Type Question/‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§≤‡§ø‡§ñ‡•ã
                <i class="fa fa-2x fa-pencil"></i>
            </button>
        </div>

        <!-- <div class="app">

            <h3>Add New Note</h3>
            <div class="input-single">
                <textarea id="note-textarea" placeholder="Create a new note by typing or using voice recognition." rows="6"></textarea>
            </div>
            <button class="btn btn-primary" id="start-record-btn" title="Start Recording">Start recording</button>
            <button class="btn btn-primary" id="pause-record-btn" title="Pause Recording">Pause Recording</button>
            <button class="btn btn-primary" id="save-note-btn" title="Save Note">send node</button>
            <p id="recording-instructions">Press the
                <strong>Start Recording</strong> button and allow access.</p>

            <h3>Response</h3>
            <ul id="response">
                <li>
                    <p class="no-notes">You don't have any query.</p>
                </li>
            </ul>

        </div>
        <audio id="recordedAudio"></audio>
    </div> -->

        <div class="app">
            <div id="type" style="display: none">
                <h3>Add New Note</h3>
                <div class="input-single">
                    <form class="ui form">
                        <textarea id="note-textarea" onclick="remove_text_response()" placeholder="Create a new note by typing or using voice recognition." rows="6" /></textarea>
                    </form>
                    <br>
                    <button class="btn btn-primary" id="save-note-btn" title="Save Note">Send&nbsp;
                        <i class="fa fa-paper-plane" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <div id="speak">
                <div>
                    <select name="languages_select" id="languages_select">
                        <option value="en-IN" data-language="ENGLISH" selected="selected">
                            English
                        </option>
                        <option value="hi-IN" data-language="HINDI">
                            ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)
                        </option>
                        <option value="mr-IN" data-language="MARATHI">
                            ‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)
                        </option>
                        <option value="gu-IN" data-language="GUJRATI">
                            ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujrati)
                        </option>
                        <option value="ta-IN" data-language="TAMIL">
                            ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)
                        </option>
                        <option value="kn-IN" data-language="KANNADA">
                            ‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)
                        </option>
                        <option value="te-IN" data-language="TELUGU">
                            ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)
                        </option>
                        <option value="bn-IN" data-language="BENGALI">
                            ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)
                        </option>
                    </select>
                </div>

                <br/>
                <br/>
                <button class="btn btn-primary" id="start-record-btn" title="Start Recording">Start recording</button>
                <button class="btn btn-primary" id="pause-record-btn" title="Pause Recording">Pause Recording</button>
                <p id="recording-instructions">Press the
                    <strong>Start Recording</strong> button and allow access.</p>
                <audio id="recordedAudio"></audio>

            </div>



            <!-- <h3>Response</h3>
            <ul id="response">
                <li>
                    <p class="no-notes">You don't have any query.</p>
                </li>
            </ul> -->
            <h3>RESPONSE</h3>
            <div id="response_output">
                
            </div>
            
            
            <!-- <button onclick='responsiveVoice.speak();' type='button' value='üîä Play' ></button> -->
            
            
            
            <!-- https://code.responsivevoice.org/getvoice.php?t=%E0%A4%A8%E0%A4%AE%E0%A4%B8%E0%A5%8D%E0%A4%A4%E0%A5%87%20%E0%A4%86%E0%A4%AA%20%E0%A4%95%E0%A5%88%E0%A4%B8%E0%A5%87%20%E0%A4%B9%E0%A5%88%E0%A4%82&tl=EN-IN -->
            <!-- <a href="https://code.responsivevoice.org/getvoice.php?t=" + "‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‡§Ü‡§™ ‡§ï‡•à‡§∏‡•á ‡§π‡•à‡§Ç" + "&tl=EN-IN">HITTT</a> -->
        </div>

    </div>



    <!-- <script src='//vws.responsivevoice.com/v/e?key=NOUukMu2'></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- <script src="script.js"></script> -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>

    <!-- Only used for the demos ads. Please ignore and remove. -->
    <script src="https://cdn.tutorialzine.com/misc/enhance/v3.js" async></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script>
        var output_received = ""
        // var voicelist = responsiveVoice.getVoices();
        // console.log(voicelist)
        let languages_select = document.getElementById('languages_select')
        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            .then(stream => {
                const mime = ['audio/wav', 'audio/mpeg', 'audio/webm', 'audio/ogg']
                    .filter(MediaRecorder.isTypeSupported)[0];
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mime
                });

                let start = document.getElementById("start-record-btn")
                let stop = document.getElementById("pause-record-btn")
                let recorded = document.getElementById("recordedAudio")
                let chunks = []
                var response_output = document.getElementById("response_output");
                start.addEventListener('click', (ev) => {
                    mediaRecorder.start();
                    console.log("start")
                    response_output.style.display = "none";
                });
                stop.addEventListener('click', (ev) => {
                    mediaRecorder.stop();
                    console.log("stop")
                    console.log(mediaRecorder.state);
                    // response_output.style.display = "none";
                });
                mediaRecorder.ondataavailable = function (ev) {
                    chunks.push(ev.data);
                    // console.log();
                }
                mediaRecorder.onstop = (ev) => {
                    // let blob = new Blob(chunks, { 'type': 'audio/wav; codecs=MS_PCM' });
                    let blob = new Blob(chunks, { 'type': 'audio/x-wav;' });

                    // 0
                    recorded.src = URL.createObjectURL(blob)
                    console.log(blob);
                    recorded.controls = true;
                    recorded.autoplay = true;
                    chunks = []
                    let data = new FormData();
                    var lang_code_selected = languages_select.options[languages_select.selectedIndex].value
                    // console.log(lang_code_selected);
                    data.append('file', blob)
                    data.append('content_type', "speech")
                    data.append("lang_code",lang_code_selected)
                    console.log(data)
                    $.ajax({
                        // url: "https://d0c97f7c.ngrok.io/post/",
                        // url: "http://127.0.0.1:8000/speechtotext/",   
                        url: "http://127.0.0.1:8000/post/",

                        type: "POST",
                        data: data,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            console.log(data);
                        },
                        error: function (err) {
                            console.log(err);
                        }
                    }).done(function (data) {
                        if (data.error) {
                            // console.log("error: ", data.error);
                            // $('#errorAlert').text(data.error).show();
                            // $('#successAlert').hide();
                        }
                        else {

                            console.log("success: ", data);
                            
                            // let html_response = '<h3>RESPONSE</h3><p>TEXT : ' + data.text_response + '</p>';
                            let html_response = data['text_response']
                            output_received = data['text_response']
                            // $('#response_output').html(html_response);
                            // $('#response_output').css("display", "block");
                            console.log(data.text_response)
                            var response_output = document.getElementById("response_output");
                            // response_output.innerHTML=html_response
                            
                            // response_output.innerText=data.text_response
                            
                            response_output.innerHTML = "<p>" +  html_response + "<button onclick='responsiveVoice.speak(output_received);' type='button' value='üîä Play' >üîä Play</button></p>"
                            // response_output.innerText=html_response
                            response_output.style.display = "block";
                            // speak_response(data.text_response);
                            speak_response(html_response)
                            // console.log("TEXT RESPONSE: ",data.text_response)
                            // $('#result_sentiment').html(html_response);
                            // $('#result_sentiment').css("display", "block");


                            // $('#successAlert').text(JSON.stringify(data)).show();
                            // $('#errorAlert').hide();
                        }

                    });
                }
            });
    </script>
    <script>
        $("#save-note-btn").click(function () {
            var response_output = document.getElementById("response_output");
            response_output.style.display = "none";
            var text = $("#note-textarea").val();
            console.log(text);
            // $.post('http://127.0.0.1:8000/post/', { 'text_input': text,"content_type":"text" }, function (data, status) {
            //     console.log(status)
            //     console.log(data)
            // });
            let data = new FormData();
            data.append('text_input', text)
            data.append('content_type', "text")


            $.ajax({
                url: "http://127.0.0.1:8000/post/",

                type: "POST",
                // data: data,
                data:data,
                contentType: false,
                processData: false,
                success: function (data) {
                    console.log(data);
                },
                error: function (err) {
                    console.log(err);
                }
            }).done(function (data) {
                if (data.error) {
                    // console.log("error: ", data.error);
                    // $('#errorAlert').text(data.error).show();
                    // $('#successAlert').hide();
                }
                else {

                    console.log("success: ", data);
                    let html_response = data['text_response']
                    console.log(data.text_response)
                    var response_output = document.getElementById("response_output");
                    // response_output.innerText=html_response
                    output_received = data['text_response']
                    response_output.innerHTML = "<p>" +  html_response + "<button onclick='responsiveVoice.speak(output_received);' type='button' value='üîä Play' >üîä Play</button></p>"
                    
                    response_output.style.display = "block";
                    speak_response(html_response)
                    // let html_response = '<h3>RESPONSE</h3><p>Sentiment : ' + data.sentiment + '<br/>Confidence : ' + data.confidence + '<br/>Text : ' + data.text + '</p>';
                    // $('#response_output').html(html_response);
                    // $('#result_sentiment').css("display", "block");


                    // $('#successAlert').text(JSON.stringify(data)).show();
                    // $('#errorAlert').hide();
                }

            });
        });

    </script>
    <script>
        function show_type_div() {
            var response_output = document.getElementById("response_output");
            response_output.style.display = "none";
            var type_div = document.getElementById("type");
            var speak_div = document.getElementById("speak");
            var speak_btn = document.getElementById("speak_btn");
            speak_div.style.display = "none";
            type_div.style.display = "block";
            speak_btn.classList.remove("active");
        }
        function show_speak_div() {
            var response_output = document.getElementById("response_output");
            response_output.style.display = "none";
            var speak_div = document.getElementById("speak");
            var type_div = document.getElementById("type");
            type_div.style.display = "none";
            speak_div.style.display = "block";           
            // type_btn
        } 

        function speak_response(speak_res){
            // var response_output = document.getElementById("response_output");
            console.log(speak_res);
            responsiveVoice.speak(speak_res,"UK English Female");

        }

        function remove_text_response(){
            var response_output = document.getElementById("response_output");
            response_output.style.display = "none";
            
        }
    </script>
</body>

</html>